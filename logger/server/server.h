// limztudio@gmail.com
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


#pragma once


#include <microhttpd.h>

#include <logger/common.h>


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


NWB_LOG_BEGIN


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


constexpr tchar SERVER_NAME[] = NWB_TEXT("Server");
class Server : public BaseUpdateOrdinary<Server, 0.1f, SERVER_NAME>{
    friend class Base;
    friend class BaseUpdateOrdinary;


private:
    static MHD_Result requestCallback(void* cls, MHD_Connection* connection, const char* url, const char* method, const char* version, const char* upload_data, size_t* upload_data_size, void** con_cls);


public:
    Server();
    virtual ~Server()override;


public:
    using Base::enqueue;


protected:
    bool internalInit(u16 port);
    bool internalUpdate();

protected:
    using BaseUpdateOrdinary::enqueue;
    using BaseUpdateOrdinary::tryDequeue;


private:
    MHD_Daemon* m_daemon;
};


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


namespace __hidden_logger{


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


extern Server* g_Logger;


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


};


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


NWB_LOG_END


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


#define NWB_LOGGER_REGISTER(inst) NWB::Log::__hidden_logger::g_Logger = inst

#define NWB_LOGGER NWB_ASSERT(NWB::Log::__hidden_logger::g_Logger != nullptr);(*NWB::Log::__hidden_logger::g_Logger)


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

