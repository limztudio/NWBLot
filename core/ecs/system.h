// limztudio@gmail.com
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


#pragma once


#include "component.h"


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


NWB_ECS_BEGIN


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


enum class AccessMode : u8{
    Read,
    Write
};


struct ComponentAccess{
    ComponentTypeId typeId;
    AccessMode mode;
};


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


class World;


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


class ISystem{
public:
    virtual ~ISystem() = default;


public:
    virtual void update(World& world, float delta) = 0;


public:
    inline const FixedVector<ComponentAccess, 16>& access()const{ return m_access; }
    inline bool enabled()const{ return m_enabled; }
    inline void setEnabled(bool v){ m_enabled = v; }


protected:
    template<typename T>
    inline void readAccess(){
        m_access.push_back(ComponentAccess{ ComponentType<T>(), AccessMode::Read });
    }
    template<typename T>
    inline void writeAccess(){
        m_access.push_back(ComponentAccess{ ComponentType<T>(), AccessMode::Write });
    }


private:
    FixedVector<ComponentAccess, 16> m_access;
    bool m_enabled = true;
};


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


class SystemScheduler{
public:
    SystemScheduler();
    ~SystemScheduler();


public:
    void addSystem(ISystem* system);
    void removeSystem(ISystem* system);
    void rebuild();
    void execute(World& world, float delta);


private:
    // Each stage is a group of systems that can safely run in parallel
    Vector<Vector<ISystem*>> m_stages;
    Vector<ISystem*> m_allSystems;
    bool m_dirty;
};


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


NWB_ECS_END


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

