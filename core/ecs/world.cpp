// limztudio@gmail.com
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


#include "world.h"


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


NWB_ECS_BEGIN


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


World::World(u32 workerThreads, Alloc::CoreAffinity affinity, usize poolArenaSize)
    : m_threadPool(
        (workerThreads > 0) ? workerThreads : Alloc::QueryCoreCount(affinity),
        affinity,
        poolArenaSize
    )
    , Alloc::ITaskScheduler(m_threadPool)
{}
World::~World()
{
    m_threadPool.wait();
    m_systems.clear();
    m_pools.clear();
}


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


Entity World::createEntity(){
    return m_entityManager.create();
}

void World::destroyEntity(Entity entity){
    if(!m_entityManager.alive(entity))
        return;

    destroyEntityComponents(entity);
    m_entityManager.destroy(entity);
}

bool World::alive(Entity entity)const{
    return m_entityManager.alive(entity);
}

usize World::entityCount()const{
    return m_entityManager.count();
}


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


void World::destroyEntityComponents(Entity entity){
    for(auto& [typeId, pool] : m_pools){
        if(pool->has(entity))
            pool->remove(entity);
    }
}


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


void World::removeSystem(ISystem* system){
    m_scheduler.removeSystem(system);

    auto itr = std::find_if(m_systems.begin(), m_systems.end(),
        [system](const UniquePtr<ISystem>& ptr){ return ptr.get() == system; }
    );
    if(itr != m_systems.end())
        m_systems.erase(itr);
}


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


void World::tick(float delta){
    m_scheduler.execute(*this, delta);
}


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


NWB_ECS_END


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

